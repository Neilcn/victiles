{% style %}
.masonry-gallery-section {
  padding-top: 2rem;
  padding-bottom: 2rem;
}

.masonry-filters-container {
  margin-bottom: 2rem;
}

.filter-group {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem;
}

.filter-label {
  font-weight: bold;
  min-width: 60px;
}

.filter-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.filter-btn {
  background: transparent;
  border: 1px solid currentColor;
  padding: 0.5rem 1rem;
  border-radius: 4px; /* Adjust as per theme settings */
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 1.4rem;
}

.filter-btn:hover {
  opacity: 0.7;
}

.filter-btn.active {
  background: #000;
  color: #fff;
  border-color: #000;
}

#clear-filters {
  margin-top: 1rem;
  display: none; /* Hidden by default */
}

#clear-filters.visible {
  display: inline-block;
}

.masonry-grid {
  column-count: 1;
  column-gap: 1.5rem;
}

@media screen and (min-width: 750px) {
  .masonry-grid {
    column-count: 2;
  }
}

@media screen and (min-width: 990px) {
  .masonry-grid {
    column-count: 3;
  }
}

.masonry-item {
  break-inside: avoid;
  margin-bottom: 1.5rem;
  position: relative;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.masonry-item-content {
  position: relative;
  display: block;
}

.masonry-item.hidden {
  display: none;
}

.masonry-image {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 4px;
}

.masonry-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 1rem;
  background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  z-index: 1;
}

.masonry-item:hover .masonry-overlay {
  opacity: 1;
}

.masonry-overlay .badge {
  background: rgba(255,255,255,0.9);
  color: #000;
  padding: 0.2rem 0.5rem;
  font-size: 1.2rem;
  border-radius: 2px;
}

.masonry-item:hover {
  transform: translateY(-5px);
  z-index: 2;
}
/* Hotspots */
.hotspot-container {
  position: absolute;
  z-index: 10;
  transform: translate(-50%, -50%);
}

.hotspot-dot {
  width: 24px;
  height: 24px;
  background-color: #fff;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  display: block;
  padding: 0;
  animation: pulse 2s infinite;
}

.hotspot-dot::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 8px;
  height: 8px;
  background-color: #000;
  border-radius: 50%;
}

@keyframes pulse {
  0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
  70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
  100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}

.hotspot-card {
  position: absolute;
  bottom: 150%;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  padding: 10px;
  border-radius: 4px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  width: 200px;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  pointer-events: none;
  z-index: 20;
}

.hotspot-dot:hover + .hotspot-card,
.hotspot-card:hover {
  opacity: 1;
  visibility: visible;
  bottom: 125%; /* Move slightly down on hover for effect */
  pointer-events: auto;
}

/* Triangle for tooltip */
.hotspot-card::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -8px;
  border-width: 8px;
  border-style: solid;
  border-color: #fff transparent transparent transparent;
}

.hotspot-card-link {
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hotspot-product-image {
  width: 100%;
  height: auto;
  border-radius: 2px;
  object-fit: cover;
}

.hotspot-product-info {
  display: flex;
  flex-direction: column;
  text-align: center;
}

.hotspot-product-title {
  font-size: 0.9rem;
  font-weight: 600;
  line-height: 1.2;
  margin-bottom: 4px;
}

.hotspot-product-price {
  font-size: 0.85rem;
  color: #555;
}

{% endstyle %}


<div class="masonry-gallery-section wt-product__wrapper">
  {% if section.settings.heading != blank %}
    <h2 class="title inline-richtext {{ section.settings.heading_size }}">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="masonry-filters-container">
    <div class="filter-group" id="filter-group-room" data-filter-group="room">
      <span class="filter-label">Room:</span>
      <div class="filter-buttons"></div>
    </div>
    <div class="filter-group" id="filter-group-colour" data-filter-group="colour">
      <span class="filter-label">Colour:</span>
      <div class="filter-buttons"></div>
    </div>
    <div class="filter-group" id="filter-group-style" data-filter-group="style">
      <span class="filter-label">Style:</span>
      <div class="filter-buttons"></div>
    </div>
    <button id="clear-filters" class="button button--secondary">Clear All</button>
  </div>

  <div class="masonry-grid" id="masonry-grid">
    {% for block in section.blocks %}
      {% if block.settings.image != blank %}
        <div class="masonry-item" 
             data-room="{{ block.settings.room | strip | escape }}" 
             data-colour="{{ block.settings.colour | strip | escape }}" 
             data-style="{{ block.settings.style | strip | escape }}">
          <div class="masonry-item-content">
            <img
              src="{{ block.settings.image | image_url: width: 600 }}"
              alt="{{ block.settings.image.alt | escape }}"
              loading="lazy"
              width="{{ block.settings.image.width }}"
              height="{{ block.settings.image.height }}"
              class="masonry-image"
            >
            <div class="masonry-overlay">
              {% if block.settings.room != blank %}<span class="badge">{{ block.settings.room }}</span>{% endif %}
              {% if block.settings.colour != blank %}<span class="badge">{{ block.settings.colour }}</span>{% endif %}
              {% if block.settings.style != blank %}<span class="badge">{{ block.settings.style }}</span>{% endif %}
            </div>
            
            {% comment %} Hotspots loop {% endcomment %}
            {% for i in (1..3) %}
              {% assign product_setting = 'product_' | append: i %}
              {% assign x_setting = 'hotspot_x_' | append: i %}
              {% assign y_setting = 'hotspot_y_' | append: i %}
              {% assign product = block.settings[product_setting] %}
              
              {% if product != blank %}
                <div class="hotspot-container" style="left: {{ block.settings[x_setting] }}%; top: {{ block.settings[y_setting] }}%;">
                  <button class="hotspot-dot" aria-label="View product: {{ product.title }}"></button>
                  <div class="hotspot-card">
                    <a href="{{ product.url }}" class="hotspot-card-link">
                      {% if product.featured_image %}
                        <img 
                          src="{{ product.featured_image | image_url: width: 150 }}" 
                          height="{{ product.featured_image.height }}" 
                          width="{{ product.featured_image.width }}" 
                          loading="lazy" 
                          alt="{{ product.title | escape }}"
                          class="hotspot-product-image"
                        >
                      {% endif %}
                      <div class="hotspot-product-info">
                        <span class="hotspot-product-title">{{ product.title }}</span>
                        <span class="hotspot-product-price">{{ product.price | money }}</span>
                      </div>
                    </a>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

{% schema %}
{
  "name": "Masonry Filter Gallery",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Gallery"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "Small"
        },
        {
          "value": "h1",
          "label": "Medium"
        },
        {
          "value": "h0",
          "label": "Large"
        }
      ],
      "default": "h1",
      "label": "Heading Size"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Gallery Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "room",
          "label": "Room",
          "info": "Filterable category (e.g. Kitchen)"
        },
        {
          "type": "text",
          "id": "colour",
          "label": "Colour",
          "info": "Filterable category (e.g. Blue)"
        },
        {
          "type": "text",
          "id": "style",
          "label": "Style",
          "info": "Filterable category (e.g. Modern)"
        },
        {
          "type": "header",
          "content": "Hotspot 1"
        },
        {
          "type": "product",
          "id": "product_1",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "hotspot_x_1",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position",
          "default": 30
        },
        {
          "type": "range",
          "id": "hotspot_y_1",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position",
          "default": 30
        },
        {
          "type": "header",
          "content": "Hotspot 2"
        },
        {
          "type": "product",
          "id": "product_2",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "hotspot_x_2",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position",
          "default": 50
        },
        {
          "type": "range",
          "id": "hotspot_y_2",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position",
          "default": 50
        },
        {
          "type": "header",
          "content": "Hotspot 3"
        },
        {
          "type": "product",
          "id": "product_3",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "hotspot_x_3",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position",
          "default": 70
        },
        {
          "type": "range",
          "id": "hotspot_y_3",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position",
          "default": 70
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Masonry Filter Gallery",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}

<script >
document.addEventListener('DOMContentLoaded', () => {
  const grid = document.getElementById('masonry-grid');
  const items = Array.from(grid.querySelectorAll('.masonry-item'));
  const clearBtn = document.getElementById('clear-filters');
  
  const activeFilters = {
    room: null,
    colour: null,
    style: null
  };

  // Helper to normalize strings directly from data attributes
  // We use the exact string from input to allow case-insensitive matching if needed, 
  // but usually users want exact matches visually. We'll trim.
  // Data attributes are already populated.
  
  function getUniqueValues(attributeName) {
    const values = new Set();
    items.forEach(item => {
      const val = item.getAttribute(`data-${attributeName}`);
      if (val) {
        values.add(val.trim());
      }
    });
    return Array.from(values).sort();
  }

  function createButtons(groupName, values) {
    const container = document.querySelector(`#filter-group-${groupName} .filter-buttons`);
    if(!container) return;

    values.forEach(val => {
      if(!val) return;
      
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'filter-btn';
      btn.textContent = val;
      btn.dataset.value = val;
      btn.dataset.group = groupName;
      
      btn.addEventListener('click', () => {
        toggleFilter(groupName, val, btn);
      });
      
      container.appendChild(btn);
    });
  }

  function toggleFilter(group, value, btnElement) {
    // If clicking active button, deselect it
    if (activeFilters[group] === value) {
      activeFilters[group] = null;
      btnElement.classList.remove('active');
    } else {
      // Deselect other buttons in same group
      const buttons = document.querySelectorAll(`#filter-group-${group} .filter-btn`);
      buttons.forEach(b => b.classList.remove('active'));
      
      // Select new
      activeFilters[group] = value;
      btnElement.classList.add('active');
    }
    
    applyFilters();
  }

  function applyFilters() {
    let hasActiveFilters = false;
    
    items.forEach(item => {
      let isVisible = true;
      
      for (const [key, filterValue] of Object.entries(activeFilters)) {
        if (filterValue) {
          hasActiveFilters = true;
          const itemValue = item.getAttribute(`data-${key}`);
          // Simple string match. Could be case-insensitive if desired: 
          // if (itemValue.toLowerCase() !== filterValue.toLowerCase())
          if (itemValue !== filterValue) {
            isVisible = false;
            break;
          }
        }
      }
      
      if (isVisible) {
        item.classList.remove('hidden');
        // Trigger a re-layout or animation if using a JS masonry library
      } else {
        item.classList.add('hidden');
      }
    });

    if (hasActiveFilters) {
      clearBtn.classList.add('visible');
    } else {
      clearBtn.classList.remove('visible');
    }
  }

  clearBtn.addEventListener('click', () => {
    // Reset state
    for (const key in activeFilters) {
      activeFilters[key] = null;
    }
    // Remove active classes
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    applyFilters();
  });

  // Initialize
  ['room', 'colour', 'style'].forEach(group => {
    const values = getUniqueValues(group);
    createButtons(group, values);
  });
});

</script>